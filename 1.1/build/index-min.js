/*! velocity - v1.1 - 2013-05-30 9:55:10 PM
* Copyright (c) 2013 hanwen.sah; Licensed  */
KISSY.add("gallery/velocity/1.1/index",function(e){var t=function(e){this.test="merge test 1.2.2",this.asts=e,this.init()};t.Helper={},t.prototype={constructor:t};var i=!{toString:1}.propertyIsEnumerable("toString"),r=Object.keys||function(e){var t,r,s=[];for(t in e)s.push(t);if(i)for(r=enumProperties.length-1;r>=0;r--)t=enumProperties[r],e.hasOwnProperty(t)&&s.push(t);return s},s={forEach:e.each,some:e.some,mixin:e.mix,guid:e.guid,isArray:e.isArray,indexOf:e.indexOf,keys:r,isObject:e.isObject,now:e.now};return!function(e,t){function i(e){var s=e.leader,n=void 0!==e.args;return e.isWraped&&(s+="{"),s+=n?r(e):e.id,t.forEach(e.path,function(e){if("method"==e.type)s+="."+r(e);else if("index"==e.type){var t="",n=e.id;if("integer"===n.type)t=n.value;else if("string"===n.type){var a=n.isEval?'"':"'";t=a+n.value+a}else t=i(n);s+="["+t+"]"}else"property"==e.type&&(s+="."+e.id)},this),e.isWraped&&(s+="}"),s}function r(e){var i=[],r="";return t.forEach(e.args,function(e){i.push(s(e))}),r+=e.id+"("+i.join(",")+")"}function s(e){var r="";switch(e.type){case"string":var n=e.isEval?'"':"'";r=n+e.value+n;break;case"integer":case"bool":r=e.value;break;case"array":r="[";var a=e.value.length-1;t.forEach(e.value,function(e,t){r+=s(e),t!==a&&(r+=", ")}),r+="]";break;default:r=i(e)}return r}e.getRefText=i}(t.Helper,s),!function(e,t){t.mixin(e.prototype,{getBlock:function(e){var t=e[0],i="";return"if"===t.type?i=this.getBlockIf(e):"foreach"===t.type?i=this.getBlockEach(e):"macro"===t.type?this.setBlockMacro(e):i="noescape"===t.type?this._render(e.slice(1)):this._render(e),i||""},setBlockMacro:function(e){var t=e[0],i=e.slice(1),r=this.macros;r[t.id]={asts:i,args:t.args}},getMacro:function(e){var i=this.macros[e.id],r="";if(i){var s=i.asts,n=i.args,a=e.args,o={},h=t.guid(),c=e.id+":"+h;t.forEach(n,function(e,t){o[e.id]=a[t]?this.getLiteral(a[t]):void 0},this),r=this.eval(s,o,c)}else{var u=this.jsmacros;i=u[e.id];var l=[];i&&i.apply&&(t.forEach(e.args,function(e){l.push(this.getLiteral(e))},this),r=i.apply(this,l))}return r},eval:function(i,r,s){if(!r)return t.isArray(i)?this._render(i):this.evalStr(i);var n=[],a=e.Parser;if(s=s||"eval:"+t.guid(),t.isArray(i)?n=i:a&&(n=a.parse(i)),n.length){this.local[s]=r;var o=this._render(n,s);return this.local[s]={},this.conditions.pop(),this.condition="",o}},getBlockEach:function(e){var i=e[0],r=this.getLiteral(i.from),s=e.slice(1),n=i.to,a={foreach:{count:0}},o="",h=t.guid(),c="foreach:"+h,u={}.toString.call(r);if(r&&("[object Array]"===u||"[object Object]"===u)){var l=t.isArray(r)?r.length:t.keys(r).length;return t.forEach(r,function(e,t){this.setBreak||(a[n]=e,a.foreach.count=t+1,a.foreach.index=t,a.foreach.hasNext=l>t+1,a.velocityCount=t+1,this.local[c]=a,o+=this._render(s,c))},this),this.setBreak=!1,this.local[c]={},this.conditions.shift(),this.condition=this.conditions[0]||"",o}},getBlockIf:function(e){var i=!1,r=[];return t.some(e,function(e){if(e.condition){if(i)return!0;i=this.getExpression(e.condition)}else if("else"===e.type){if(i)return!0;i=!0}else i&&r.push(e);return!1},this),this._render(r)}})}(t,s),!function(e,t){t.mixin(e.prototype,{init:function(){this.context={},this.macros={},this.conditions=[],this.local={},this.silence=!1,t.forEach(this.asts,this._init,this)},_init:function(e,t){e.type&&"references"===e.type||this._trim(t+1)},_trim:function(e){var t=this.asts,i=t[e];"string"==typeof i&&"\n"===i.slice(0,1)&&(t[e]=i.slice(1))},render:function(e,i,r){this.silence=!!r,this.context=e||{},this.jsmacros=i||{};var s=t.now(),n=this._render(),a=t.now(),o=a-s;return this.cost=o,n},_render:function(e,i){var r="";return e=e||this.asts,i?(i!==this.condition&&-1===t.indexOf(i,this.conditions)&&this.conditions.unshift(i),this.condition=i):this.condition=null,t.forEach(e,function(e){switch(e.type){case"references":r+=this.getReferences(e,!0);break;case"set":this.setValue(e);break;case"break":this.setBreak=!0;break;case"macro_call":r+=this.getMacro(e);break;case"comment":break;default:r+="string"==typeof e?e:this.getBlock(e)}},this),r}})}(t,s),!function(e,t){t.mixin(e.prototype,{getExpression:function(e){var t,i=e.expression;if("math"===e.type){switch(e.operator){case"+":t=this.getExpression(i[0])+this.getExpression(i[1]);break;case"-":t=this.getExpression(i[0])-this.getExpression(i[1]);break;case"/":t=this.getExpression(i[0])/this.getExpression(i[1]);break;case"%":t=this.getExpression(i[0])%this.getExpression(i[1]);break;case"*":t=this.getExpression(i[0])*this.getExpression(i[1]);break;case"||":t=this.getExpression(i[0])||this.getExpression(i[1]);break;case"&&":t=this.getExpression(i[0])&&this.getExpression(i[1]);break;case">":t=this.getExpression(i[0])>this.getExpression(i[1]);break;case"<":t=this.getExpression(i[0])<this.getExpression(i[1]);break;case"==":t=this.getExpression(i[0])==this.getExpression(i[1]);break;case">=":t=this.getExpression(i[0])>=this.getExpression(i[1]);break;case"<=":t=this.getExpression(i[0])<=this.getExpression(i[1]);break;case"!=":t=this.getExpression(i[0])!=this.getExpression(i[1]);break;case"minus":t=-this.getExpression(i[0]);break;case"not":t=!this.getExpression(i[0]);break;case"parenthesis":t=this.getExpression(i[0]);break;default:return}return t}return this.getLiteral(e)}})}(t,s),!function(e,t){t.mixin(e.prototype,{getLiteral:function(e){var i=e.type,r="";if("string"==i)r=this.getString(e);else if("integer"==i)r=parseInt(e.value,10);else if("decimal"==i)r=parseFloat(e.value,10);else if("array"==i)r=this.getArray(e);else if("map"==i){r={};var s=e.value;t.forEach(s,function(e,t){r[t]=this.getLiteral(e)},this)}else{if("bool"!=i)return this.getReferences(e);"null"===e.value?r=null:"false"===e.value?r=!1:"true"===e.value&&(r=!0)}return r},getString:function(e){var t=e.value,i=t;return!e.isEval||-1===t.indexOf("#")&&-1===t.indexOf("$")||(i=this.evalStr(t)),i},getArray:function(e){var i=[];if(e.isRange){var r=e.value[0];"references"===r.type&&(r=this.getReferences(r));var s=e.value[1];"references"===s.type&&(s=this.getReferences(s)),s=parseInt(s,10),r=parseInt(r,10);var n;if(!isNaN(r)&&!isNaN(s))if(s>r)for(n=r;s>=n;n++)i.push(n);else for(n=r;n>=s;n--)i.push(n)}else t.forEach(e.value,function(e){i.push(this.getLiteral(e))},this);return i},evalStr:function(t){if(e.Parser){var i=e.Parser.parse(t);r=this._render(i)}else{var r=t,s=/\$\{{0,1}([_a-z][a-z_\-0-9.]*)\}{0,1}/gi,n=this;r=r.replace(s,function(){return n._getFromVarname(arguments[1])})}return r},_getFromVarname:function(e){for(var t=e.split("."),i={type:"references",id:t[0],leader:"$"},r=[],s=1;t.length>s;s++)r.push({type:"property",id:t[s]});return r.length&&(i.path=r),this.getReferences(i)}})}(t,s),!function(e,t){function i(e){return t.isArray(e)?e.length:t.isObject(e)?t.keys(e).length:void 0}t.mixin(e.prototype,{getReferences:function(i,r){var s=this.silence||"$!"===i.leader,n=void 0!==i.args,a=this.context,o=a[i.id],h=this.getLocal(i);void 0!==o&&n&&(o=this.getPropMethod(i,a)),h.isLocaled&&(o=h.value);var c=this.hasSetMethod(i,o);return c!==!1?(a[i.id]||(a[i.id]={}),t.mixin(a[i.id],c),""):(i.path&&void 0!==o&&t.some(i.path,function(e){return o=this.getAttributes(e,o),void 0===o},this),r&&void 0===o&&(o=s?"":e.Helper.getRefText(i)),o)},hasSetMethod:function(e,i){var r={control:!0},s=e.path&&e.path.length;if(!s||r[e.id])return!1;var n=""+e.path[s-1].id;return 0!==n.indexOf("set")?!1:(i=i||{},t.forEach(e.path,function(e){"method"===e.type&&0===e.id.indexOf("set")?i[e.id.slice(3)]=this.getLiteral(e.args[0]):i[e.id]=i[e.id]||{}},this),i)},getLocal:function(e){var i=e.id,r=this.local,s=!1,n=t.some(this.conditions,function(e){var t=r[e];return i in t?(s=t[i],!0):!1},this);return{value:s,isLocaled:n}},getAttributes:function(e,t){var i,r=e.type,s=e.id;return i="method"===r?this.getPropMethod(e,t):"property"===r?t[s]:this.getPropIndex(e,t)},getPropIndex:function(e,t){var i,r=e.id;return i="references"===r.type?this.getReferences(r):"integer"===r.type?r.value:r.value,t[i]},getPropMethod:function(e,r){var s=e.id,n="",a=s.slice(3);if(!(0!==s.indexOf("get")||s in r))return a?n=r[a]:(a=this.getLiteral(e.args[0]),n=r[a]),n;if(!(0!==s.indexOf("is")||s in r))return a=s.slice(2),n=r[a];if("keySet"===s)return t.keys(r);if("entrySet"===s)return n=[],t.forEach(r,function(e,t){n.push({key:t,value:e})}),n;if("size"===s)return i(r);n=r[s];var o=[];if(t.forEach(e.args,function(e){o.push(this.getLiteral(e))},this),n&&n.call){var h=this;r.eval=function(){return h.eval.apply(h,arguments)},n=n.apply(r,o)}else n=void 0;return n}})}(t,s),!function(e,t){t.mixin(e.prototype,{getContext:function(){var e=this.condition,t=this.local;return e?t[e]:this.context},setValue:function(e){var i,r=e.equal[0],s=this.getContext(),n=e.equal[1];if(i="math"===n.type?this.getExpression(n):this.getLiteral(e.equal[1]),r.path){var a=s[r.id];"object"!=typeof a&&(a={}),s[r.id]=a;var o=r.path?r.path.length:0;t.forEach(r.path,function(e,t){var r=o===t+1,s=e.id;"index"===e.type&&(s=s.value),a[s]=r?i:{},a=a[s]})}else s[r.id]=i}})}(t,s),t});