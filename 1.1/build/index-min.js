/*! velocity - v1.1 - 2013-04-16 5:52:25 PM
* Copyright (c) 2013 hanwen.sah; Licensed  */
KISSY.add(function(e){var t=function(e){this.testString="hello world, more and more and more, end",this.asts=e,this.init()};t.Helper={},t.prototype={constructor:t};var i=!{toString:1}.propertyIsEnumerable("toString"),r=Object.keys||function(e){var t,r,s=[];for(t in e)s.push(t);if(i)for(r=enumProperties.length-1;r>=0;r--)t=enumProperties[r],e.hasOwnProperty(t)&&s.push(t);return s},s={forEach:e.each,some:e.some,mixin:e.mix,guid:e.guid,isArray:e.isArray,indexOf:e.indexOf,keys:r,now:e.now};return!function(e,t){function i(e){var s=e.leader,n=void 0!==e.args;return e.isWraped&&(s+="{"),s+=n?r(e):e.id,t.forEach(e.path,function(e){if("method"==e.type)s+="."+r(e);else if("index"==e.type){var t="",n=e.id;if("integer"===n.type)t=n.value;else if("string"===n.type){var a=n.isEval?'"':"'";t=a+n.value+a}else t=i(n);s+="["+t+"]"}else"property"==e.type&&(s+="."+e.id)},this),e.isWraped&&(s+="}"),s}function r(e){var r=[],s="";return t.forEach(e.args,function(e){if("string"===e.type){var t=e.isEval?'"':"'",s=t+e.value+t;r.push(s)}else r.push(i(e))}),s+=e.id+"("+r.join(",")+")"}e.getRefText=i}(t.Helper,s),!function(e,t){t.mixin(e.prototype,{getBlock:function(e){var i=e[0],r="",s=[i],n=[],a=0,o=["if","foreach","macro","noescape"];return t.forEach(e,function(e,i){i&&(-1!==t.indexOf(e.type,o)?(a++,n.push(e)):"end"===e.type?(a--,a?n.push(e):(s.push(n.slice()),n=[])):a?n.push(e):s.push(e))}),"if"===i.type?r=this.getBlockIf(s):"foreach"===i.type?r=this.getBlockEach(s):"macro"===i.type?this.setBlockMacro(s):"noescape"===i.type&&(r=this._render(s.slice(1))),r},setBlockMacro:function(e){var t=e[0],i=e.slice(1),r=this.macros;r[t.id]={asts:i,args:t.args}},getMacro:function(e){var i=this.macros[e.id],r="";if(i){var s=i.asts,n=i.args,a=e.args,o={},h=t.guid(),c=e.id+":"+h;t.forEach(n,function(e,t){o[e.id]=a[t]?this.getLiteral(a[t]):void 0},this),this.local[c]=o,r=this._render(s,c),this.local[c]={},this.conditions.pop(),this.condition=""}else r="";return r},getBlockEach:function(e){var i=e[0],r=this.getLiteral(i.from),s=e.slice(1),n=i.to,a={foreach:{count:0}},o="",h=t.guid(),c="foreach:"+h;if(r){var u=t.isArray(r)?r.length:t.keys(r).length;return t.forEach(r,function(e,t){this.setBreak||(a[n]=e,a.foreach.count=t+1,a.foreach.index=t,a.foreach.hasNext=u>t+1,this.local[c]=a,o+=this._render(s,c))},this),this.setBreak=!1,this.local[c]={},this.conditions.pop(),this.condition="",o}},getBlockIf:function(e){var i=!1,r=[];return t.some(e,function(e){if(e.condition){if(i)return!0;i=this.getExpression(e.condition)}else if("else"===e.type){if(i)return!0;i=!0}else i&&r.push(e);return!1},this),this._render(r)}})}(t,s),!function(e,t){var i=["if","foreach","macro","noescape"];t.mixin(e.prototype,{init:function(){this.context={},this.macros={},this.conditions=[],this.local={},t.forEach(this.asts,this._init,this)},_init:function(e,t){e.type&&"references"===e.type||this._trim(t+1)},_trim:function(e){var t=this.asts,i=t[e];"string"==typeof i&&"\n"===i.slice(0,1)&&(t[e]=i.slice(1))},render:function(e){this.context=e||{};var i=t.now(),r=this._render(),s=t.now(),n=s-i;return this.cost=n,r},_render:function(e,r){var s="",n=[],a=0;return e=e||this.asts,r?(r!==this.condition&&this.conditions.push(r),this.condition=r):this.condition=null,t.forEach(e,function(e){var r=e.type;if(t.indexOf(r,i)>-1&&a++,"comment"!==r){if(a&&("end"===r&&a--,a))return n.push(e),void 0;switch(r){case"references":s+=this.getReferences(e,!0);break;case"set":this.setValue(e);break;case"break":this.setBreak=!0;break;case"macro_call":s+=this.getMacro(e);break;case"parse":s+=this.getParse(e);break;case"end":s+=this.getBlock(n.slice()),n=[];break;default:s+=t.isArray(e)?this.getBlock(e):e}}},this),s}})}(t,s),!function(e,t){t.mixin(e.prototype,{getExpression:function(e){var t,i=e.expression;if("math"===e.type){switch(e.operator){case"+":t=this.getExpression(i[0])+this.getExpression(i[1]);break;case"-":t=this.getExpression(i[0])-this.getExpression(i[1]);break;case"/":t=this.getExpression(i[0])/this.getExpression(i[1]);break;case"*":t=this.getExpression(i[0])*this.getExpression(i[1]);break;case"||":t=this.getExpression(i[0])||this.getExpression(i[1]);break;case"&&":t=this.getExpression(i[0])&&this.getExpression(i[1]);break;case">":t=this.getExpression(i[0])>this.getExpression(i[1]);break;case"<":t=this.getExpression(i[0])<this.getExpression(i[1]);break;case"==":t=this.getExpression(i[0])==this.getExpression(i[1]);break;case"!=":t=this.getExpression(i[0])!=this.getExpression(i[1]);break;case"minus":t=-this.getExpression(i[0]);break;case"not":t=!this.getExpression(i[0]);break;case"parenthesis":t=this.getExpression(i[0]);break;default:return}return t}return this.getLiteral(e)}})}(t,s),!function(e,t){t.mixin(e.prototype,{getLiteral:function(e){var i=e.type,r="";if("string"==i)r=this.getString(e);else if("integer"==i)r=parseInt(e.value,10);else if("array"==i)r=this.getArray(e);else if("map"==i){r={};var s=e.value;t.forEach(s,function(e,t){r[t]=this.getLiteral(e)},this)}else{if("bool"!=i)return this.getReferences(e);"null"===e.value?r=null:"false"===e.value?r=!1:"true"===e.value&&(r=!0)}return r},getString:function(e){var t=e.value,i=t;return!e.isEval||-1===t.indexOf("#")&&-1===t.indexOf("$")||(i=this.evalStr(t)),i},getArray:function(e){var i=[];if(e.isRange){var r,s=parseInt(e.value[0],10),n=parseInt(e.value[1],10);if(n>s)for(r=s;n>=r;r++)i.push(r);else for(r=s;r>=n;r--)i.push(r)}else t.forEach(e.value,function(e){i.push(this.getLiteral(e))},this);return i},evalStr:function(t){if(e.Parser){var i=e.Parser.parse(t);r=this._render(i)}else{var r=t,s=/\$\{{0,1}([_a-z][a-z_\-0-9.]*)\}{0,1}/gi,n=this;r=r.replace(s,function(){return n._getFromVarname(arguments[1])})}return r},_getFromVarname:function(e){for(var t=e.split("."),i={type:"references",id:t[0],leader:"$"},r=[],s=1;t.length>s;s++)r.push({type:"property",id:t[s]});return r.length&&(i.path=r),this.getReferences(i)}})}(t,s),!function(e,t){t.mixin(e.prototype,{getParse:function(t){var i=this.getLiteral(t.id),r=e.getParseString,s=e.Parser;if(r&&s){var n=r(i),a=s.parse(n);return this._render(a)}return"#parse("+("references"===t.id.type?e.Helper.getRefText(t.id):'"'+t.id+'"')+")"}})}(t,s),!function(e,t){t.mixin(e.prototype,{getReferences:function(i,r){var s="$!"===i.leader,n=void 0!==i.args,a=this.context,o=a[i.id],h=this.getLocal(i);void 0!==o&&n&&(o=this.getPropMethod(i,a)),h.isLocaled&&(o=h.value);var c=this.hasSetMethod(i,o);return c!==!1?(a[i.id]||(a[i.id]={}),t.mixin(a[i.id],c),""):(i.path&&void 0!==o&&t.some(i.path,function(e){return o=this.getAttributes(e,o),void 0===o},this),r&&void 0===o&&(o=s?"":e.Helper.getRefText(i)),o)},hasSetMethod:function(e,i){var r=e.path&&e.path.length;if(!r)return!1;var s=""+e.path[r-1].id;return 0!==s.indexOf("set")?!1:(i=i||{},t.forEach(e.path,function(e){"method"===e.type&&0===e.id.indexOf("set")?i[e.id.slice(3)]=this.getLiteral(e.args[0]):i[e.id]=i[e.id]||{}},this),i)},getLocal:function(e){var i=e.id,r=this.local,s=!1,n=t.some(this.conditions,function(e){var t=r[e];return i in t?(s=t[i],!0):!1},this);return{value:s,isLocaled:n}},getAttributes:function(e,t){var i,r=e.type,s=e.id;return i="method"===r?this.getPropMethod(e,t):"property"===r?t[s]:this.getPropIndex(e,t)},getPropIndex:function(e,t){var i,r=e.id;i="references"===r.type?this.getReferences(r):"integer"===r.type?r.value:r.value;var s;return s=t[i]},getPropMethod:function(e,i){var r=e.id,s="",n=r.slice(3);if(r in i||0!==r.indexOf("get"))if(0===r.indexOf("is"))n=r.slice(2),s=i[n];else if("keySet"===r)s=t.keys(i);else if("entrySet"===r)s=[],t.forEach(i,function(e,t){s.push({key:t,value:e})});else{s=i[r];var a=[];t.forEach(e.args,function(e){a.push(this.getLiteral(e))},this),s=s&&s.call?s.apply(i,a):void 0}else n?s=i[n]:(n=this.getLiteral(e.args[0]),s=i[n]);return s}})}(t,s),!function(e,t){t.mixin(e.prototype,{getContext:function(){var e=this.condition,t=this.local;return e?t[e]:this.context},setValue:function(e){var i,r=e.equal[0],s=this.getContext(),n=e.equal[1];if(i="math"===n.type?this.getExpression(n):this.getLiteral(e.equal[1]),r.path){var a=s[r.id];"object"!=typeof a&&(a={}),s[r.id]=a;var o=r.path?r.path.length:0;t.forEach(r.path,function(e,t){var r=o===t+1,s=e.id;"index"===e.type&&(s=s.value),a[s]=r?i:{},a=a[s]})}else s[r.id]=i}})}(t,s),t});